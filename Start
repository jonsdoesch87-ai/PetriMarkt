import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  query, 
  doc, 
  getDoc, 
  setDoc,
  getDocs,
  updateDoc,
  deleteDoc
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken,
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  PlusCircle, 
  Search, 
  MapPin, 
  User, 
  Fish,
  Image as ImageIcon,
  MessageCircle,
  Phone,
  Send,
  ArrowLeft,
  ChevronLeft,
  Camera,
  LayoutGrid,
  Settings,
  LogOut,
  ChevronDown,
  MessageSquare,
  Edit,
  Trash2
} from 'lucide-react';

// Firebase Konfiguration (wird zur Laufzeit befüllt)
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'petri-markt-v2';

const KATEGORIEN = ['Ruten', 'Rollen', 'Köder', 'Bekleidung', 'Elektronik & Echolote', 'Boote', 'Zubehör', 'Aufbewahrung', 'Sonstiges'];
const KANTONE = ['Zürich', 'Bern', 'Luzern', 'Uri', 'Schwyz', 'Obwalden', 'Nidwalden', 'Glarus', 'Zug', 'Freiburg', 'Solothurn', 'Basel-Stadt', 'Basel-Landschaft', 'Schaffhausen', 'Appenzell A.Rh.', 'Appenzell I.Rh.', 'St. Gallen', 'Graubünden', 'Aargau', 'Thurgau', 'Tessin', 'Waadt', 'Wallis', 'Neuenburg', 'Genf', 'Jura'];

const MOCK_ADS = [
  { title: 'St. Croix Legend Tournament', price: 350, category: 'Ruten', kanton: 'Zürich', description: 'Fast neue Spinnrute, ideal für Zander.' },
  { title: 'Shimano Stella C3000HG', price: 580, category: 'Rollen', kanton: 'Bern', description: 'Frisch gewartet, läuft butterweich.' },
  { title: 'Wobbler Set (15 Stück)', price: 45, category: 'Köder', kanton: 'Luzern', description: 'Verschiedene Marken wie Rapala.' }
];

export default function App() {
  const [user, setUser] = useState(null);
  const [profile, setProfile] = useState({ firstName: '', lastName: '', email: '', phone: '', showPhone: false });
  const [view, setView] = useState('landing'); 
  const [selectedAd, setSelectedAd] = useState(null);
  const [ads, setAds] = useState([]);
  const [userChats, setUserChats] = useState([]);
  const [activeChat, setActiveChat] = useState(null);
  const [messages, setMessages] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedCategory, setSelectedCategory] = useState('Alle Kategorien');
  const [selectedKanton, setSelectedKanton] = useState('Ganze Schweiz');
  const [isUploading, setIsUploading] = useState(false);
  const [previewImage, setPreviewImage] = useState(null);
  const [showFullNumber, setShowFullNumber] = useState(false);
  const [showUserMenu, setShowUserMenu] = useState(false);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  
  const scrollRef = useRef();
  const menuRef = useRef();

  // Schließt das Benutzermenü bei Klick außerhalb
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (menuRef.current && !menuRef.current.contains(event.target)) {
        setShowUserMenu(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Firebase Authentifizierung Initialisierung
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, async (u) => {
      setUser(u);
      if (u) {
        const docRef = doc(db, 'artifacts', appId, 'users', u.uid, 'profile', 'settings');
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          setProfile(prev => ({ ...prev, ...docSnap.data() }));
          if (view === 'landing') setView('home');
        }
        seedTestData();
      }
    });
    return () => unsubscribe();
  }, []);

  const seedTestData = async () => {
    const adsRef = collection(db, 'artifacts', appId, 'public', 'data', 'ads');
    const snapshot = await getDocs(adsRef);
    if (snapshot.empty) {
      for (const item of MOCK_ADS) {
        await addDoc(adsRef, {
          ...item,
          sellerId: 'test-user-id',
          sellerName: 'Petri Testuser',
          sellerPhone: '079 123 45 67',
          createdAt: Date.now(),
          image: null
        });
      }
    }
  };

  // Echtzeit-Sync der Inserate
  useEffect(() => {
    if (!user) return;
    const adsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'ads');
    const unsubscribe = onSnapshot(query(adsCollection), (s) => {
      const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
      setAds(data.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)));
    });
    return () => unsubscribe();
  }, [user]);

  // Echtzeit-Sync der Chats
  useEffect(() => {
    if (!user) return;
    const chatsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'chats');
    const unsubscribe = onSnapshot(query(chatsCollection), (s) => {
      const allChats = s.docs.map(d => ({ id: d.id, ...d.data() }));
      const myChats = allChats.filter(chat => 
        chat.buyerId === user.uid || chat.sellerId === user.uid
      );
      setUserChats(myChats);
    });
    return () => unsubscribe();
  }, [user]);

  // Echtzeit-Sync der Nachrichten im aktiven Chat
  useEffect(() => {
    if (!activeChat || !user) return;
    const messagesCollection = collection(db, 'artifacts', appId, 'public', 'data', 'chats', activeChat.id, 'messages');
    const unsubscribe = onSnapshot(query(messagesCollection), (s) => {
      const msgs = s.docs.map(d => ({ id: d.id, ...d.data() }));
      setMessages(msgs.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0)));
      if (scrollRef.current) scrollRef.current.scrollIntoView({ behavior: 'smooth' });
    });
    return () => unsubscribe();
  }, [activeChat, user]);

  const saveProfile = async (e) => {
    e.preventDefault();
    if (!user) return;
    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'settings');
    await setDoc(docRef, profile);
    setView('home');
    setShowUserMenu(false);
  };

  const handleCreateOrUpdateAd = async (e) => {
    e.preventDefault();
    if (!user) return;
    if (!profile.firstName) { setView('account'); return; }
    setIsUploading(true);
    const fd = new FormData(e.target);
    const adData = {
      title: fd.get('title'),
      price: fd.get('price'),
      description: fd.get('description'),
      category: fd.get('category'),
      kanton: fd.get('kanton'),
      sellerId: user.uid,
      sellerName: `${profile.firstName} ${profile.lastName}`.trim(),
      sellerPhone: profile.showPhone ? profile.phone : null,
      updatedAt: Date.now(),
      image: previewImage
    };

    if (view === 'edit' && selectedAd) {
      const adRef = doc(db, 'artifacts', appId, 'public', 'data', 'ads', selectedAd.id);
      await updateDoc(adRef, adData);
    } else {
      adData.createdAt = Date.now();
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ads'), adData);
    }
    
    setPreviewImage(null);
    setIsUploading(false);
    setView('home');
    setSelectedAd(null);
  };

  const deleteAd = async () => {
    if (!selectedAd || !user) return;
    const adRef = doc(db, 'artifacts', appId, 'public', 'data', 'ads', selectedAd.id);
    await deleteDoc(adRef);
    setShowDeleteConfirm(false);
    setSelectedAd(null);
    setView('my-ads');
  };

  const startChat = async (ad) => {
    if (!user) return;
    if (!profile.firstName) { setView('account'); return; }
    const chatId = [user.uid, ad.sellerId, ad.id].sort().join('_');
    const chatRef = doc(db, 'artifacts', appId, 'public', 'data', 'chats', chatId);
    const chatSnap = await getDoc(chatRef);
    const chatData = { 
      id: chatId, 
      adId: ad.id, 
      adTitle: ad.title, 
      buyerId: user.uid, 
      buyerName: profile.firstName,
      sellerId: ad.sellerId, 
      sellerName: ad.sellerName 
    };
    if (!chatSnap.exists()) await setDoc(chatRef, chatData);
    setActiveChat(chatData);
    setView('chat');
  };

  const filteredAds = ads.filter(ad => {
    const mSearch = (ad.title || '').toLowerCase().includes(searchTerm.toLowerCase());
    const mCat = selectedCategory === 'Alle Kategorien' || ad.category === selectedCategory;
    const mKan = selectedKanton === 'Ganze Schweiz' || ad.kanton === selectedKanton;
    return mSearch && mCat && mKan;
  });

  const myAds = ads.filter(ad => ad.sellerId === user?.uid);

  // --- UI KOMPONENTEN ---

  const Header = () => (
    <header className="bg-white border-b border-[#eee] sticky top-0 z-50">
      <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
        <div className="flex items-center gap-2 cursor-pointer" onClick={() => { setView('home'); setShowFullNumber(false); }}>
          <div className="w-9 h-9 bg-[#576574] rounded-xl flex items-center justify-center text-white shadow-sm">
            <Fish size={24} />
          </div>
          <h1 className="text-xl font-black tracking-tight text-[#222f3e] hidden sm:block">PetriMarkt</h1>
        </div>

        <div className="flex items-center gap-2 sm:gap-4">
          {user && profile.firstName && (
            <div className="hidden md:flex items-center gap-1 border-r pr-4 mr-2 border-gray-100">
              <button onClick={() => setView('my-chats')} className={`p-2 px-3 rounded-xl flex items-center gap-2 text-sm font-bold transition-all ${view === 'my-chats' ? 'bg-[#576574] text-white' : 'text-gray-500 hover:bg-gray-50'}`}>
                <MessageCircle size={18} /> Chats
              </button>
              <button onClick={() => setView('my-ads')} className={`p-2 px-3 rounded-xl flex items-center gap-2 text-sm font-bold transition-all ${view === 'my-ads' ? 'bg-[#576574] text-white' : 'text-gray-500 hover:bg-gray-50'}`}>
                <LayoutGrid size={18} /> Inserate
              </button>
            </div>
          )}

          <button onClick={() => { setPreviewImage(null); setView('create'); }} className="bg-[#576574] text-white px-5 py-2.5 rounded-xl flex items-center gap-2 hover:bg-[#222f3e] text-sm font-bold transition-all shadow-sm">
            <PlusCircle size={18} /> <span className="hidden lg:inline">Inserieren</span>
          </button>

          <div className="relative" ref={menuRef}>
            <button 
              onClick={() => setShowUserMenu(!showUserMenu)}
              className={`flex items-center gap-2 p-1 pr-2 rounded-full border transition-all ${showUserMenu ? 'bg-gray-50 border-gray-300' : 'border-gray-100 hover:bg-gray-50'}`}
            >
              <div className="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 overflow-hidden">
                <User size={20} />
              </div>
              <ChevronDown size={14} className={`text-gray-400 transition-transform ${showUserMenu ? 'rotate-180' : ''}`} />
            </button>

            {showUserMenu && (
              <div className="absolute right-0 mt-2 w-56 bg-white rounded-2xl shadow-2xl border border-gray-100 overflow-hidden animate-in fade-in zoom-in duration-200">
                <div className="p-4 border-b border-gray-50 bg-gray-50/50">
                  <p className="text-xs text-gray-400 font-bold uppercase tracking-wider">Konto</p>
                  <p className="font-bold text-[#222f3e] truncate">{profile.firstName ? `${profile.firstName} ${profile.lastName}` : 'Gast'}</p>
                </div>
                <div className="p-2">
                  <button onClick={() => { setView('my-ads'); setShowUserMenu(false); }} className="w-full flex items-center gap-3 p-3 text-sm font-semibold text-gray-600 hover:bg-gray-50 rounded-xl transition-colors">
                    <LayoutGrid size={18} className="text-gray-400" /> Meine Inserate
                  </button>
                  <button onClick={() => { setView('my-chats'); setShowUserMenu(false); }} className="w-full flex items-center gap-3 p-3 text-sm font-semibold text-gray-600 hover:bg-gray-50 rounded-xl transition-colors">
                    <MessageSquare size={18} className="text-gray-400" /> Meine Chats
                  </button>
                  <button onClick={() => { setView('account'); setShowUserMenu(false); }} className="w-full flex items-center gap-3 p-3 text-sm font-semibold text-gray-600 hover:bg-gray-50 rounded-xl transition-colors">
                    <Settings size={18} className="text-gray-400" /> Profil bearbeiten
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </header>
  );

  const Modal = ({ children, onClose }) => (
    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
      <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
      <div className="bg-white rounded-[2.5rem] w-full max-w-md p-8 relative z-10 shadow-2xl animate-in fade-in zoom-in duration-200">
        {children}
      </div>
    </div>
  );

  if (view === 'landing') {
    return (
      <div className="min-h-screen flex flex-col bg-[#fbfbf9]">
        <section className="pt-24 pb-12 px-4 text-center space-y-8 bg-gradient-to-b from-[#f1f2f6] to-[#fbfbf9]">
          <div className="w-24 h-24 bg-[#576574] rounded-[2rem] mx-auto flex items-center justify-center text-white shadow-2xl">
            <Fish size={56} />
          </div>
          <h1 className="text-5xl sm:text-6xl font-black text-[#222f3e] tracking-tight leading-tight">
            Angelzubehör <br /><span className="text-[#576574]">kaufen & verkaufen.</span>
          </h1>
          <p className="max-w-xl mx-auto text-gray-500 text-xl font-medium">
            Der spezialisierte Marktplatz für Schweizer Fischer. Einfach, sicher und direkt.
          </p>
          <div className="flex flex-col sm:flex-row gap-4 justify-center pt-6">
            <button onClick={() => setView('account')} className="bg-[#222f3e] text-white px-10 py-5 rounded-2xl font-bold text-lg shadow-xl hover:scale-105 transition-all">
              Account erstellen
            </button>
            <button onClick={() => setView('home')} className="bg-white text-[#576574] border-2 border-[#576574]/20 px-10 py-5 rounded-2xl font-bold text-lg hover:border-[#576574] transition-all">
              Jetzt stöbern
            </button>
          </div>
        </section>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#fbfbf9] text-[#2d3436] pb-20 sm:pb-0 font-sans">
      <Header />

      <main className="max-w-6xl mx-auto p-4 sm:p-6">
        {view === 'home' && (
          <div className="space-y-8">
            <div className="bg-white p-5 rounded-3xl border border-[#eee] shadow-sm flex flex-col md:flex-row gap-4 items-center">
              <div className="relative flex-1 w-full">
                <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                <input type="text" placeholder="Marke, Modell, Tackle..." className="w-full pl-12 pr-4 py-4 bg-[#f8f9fa] rounded-2xl outline-none font-medium" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
              </div>
              <div className="flex gap-3 w-full md:w-auto">
                <select className="flex-1 md:w-48 p-4 bg-white border border-[#eee] rounded-2xl outline-none text-sm font-bold" value={selectedCategory} onChange={(e) => setSelectedCategory(e.target.value)}>
                  <option>Alle Kategorien</option>
                  {KATEGORIEN.map(k => <option key={k} value={k}>{k}</option>)}
                </select>
                <select className="flex-1 md:w-48 p-4 bg-white border border-[#eee] rounded-2xl outline-none text-sm font-bold" value={selectedKanton} onChange={(e) => setSelectedKanton(e.target.value)}>
                  <option>Ganze Schweiz</option>
                  {KANTONE.map(k => <option key={k} value={k}>{k}</option>)}
                </select>
              </div>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
              {filteredAds.map((ad) => (
                <div 
                  key={ad.id} 
                  onClick={() => { setSelectedAd(ad); setView('detail'); }}
                  className="bg-white rounded-[2rem] overflow-hidden border border-[#eee] shadow-sm hover:shadow-xl transition-all group cursor-pointer"
                >
                  <div className="aspect-[4/5] bg-[#f9f9f9] relative overflow-hidden flex items-center justify-center">
                    {ad.image ? <img src={ad.image} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" /> : <ImageIcon size={48} className="text-gray-200" />}
                    <div className="absolute top-4 right-4 bg-white/95 backdrop-blur px-4 py-2 rounded-2xl text-sm font-black shadow-lg">CHF {ad.price}.-</div>
                  </div>
                  <div className="p-5">
                    <span className="text-[10px] font-black text-[#576574] uppercase tracking-widest bg-gray-50 px-2 py-1 rounded-md mb-2 inline-block">{ad.category}</span>
                    <h3 className="font-bold text-lg text-[#222f3e] truncate">{ad.title}</h3>
                    <div className="flex items-center gap-2 text-gray-400 text-xs mt-2 font-medium">
                      <MapPin size={14} /> {ad.kanton}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {view === 'my-chats' && (
          <div className="max-w-2xl mx-auto space-y-6">
            <h2 className="text-3xl font-black text-[#222f3e]">Meine Nachrichten</h2>
            {userChats.length === 0 ? (
              <div className="bg-white p-12 rounded-[2.5rem] text-center border border-dashed border-gray-200">
                <MessageSquare size={48} className="mx-auto text-gray-200 mb-4" />
                <p className="text-gray-400 font-bold">Noch keine Konversationen gestartet.</p>
                <button onClick={() => setView('home')} className="mt-4 text-[#576574] font-black text-sm uppercase tracking-widest">Jetzt stöbern</button>
              </div>
            ) : (
              <div className="space-y-3">
                {userChats.map(chat => (
                  <div 
                    key={chat.id} 
                    onClick={() => { setActiveChat(chat); setView('chat'); }}
                    className="bg-white p-5 rounded-3xl border border-gray-100 flex items-center gap-4 hover:shadow-md cursor-pointer transition-all"
                  >
                    <div className="w-12 h-12 bg-[#f1f2f6] rounded-2xl flex items-center justify-center text-[#576574]">
                      <User size={24} />
                    </div>
                    <div className="flex-1 overflow-hidden">
                      <h4 className="font-bold text-[#222f3e] truncate">{chat.adTitle}</h4>
                      <p className="text-xs text-gray-400 font-medium">
                        {chat.sellerId === user.uid ? `Käufer: ${chat.buyerName || 'Interessent'}` : `Verkäufer: ${chat.sellerName}`}
                      </p>
                    </div>
                    <ChevronLeft className="rotate-180 text-gray-300" size={20} />
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {view === 'my-ads' && (
          <div className="space-y-6">
            <h2 className="text-3xl font-black text-[#222f3e]">Meine Inserate</h2>
            {myAds.length === 0 ? (
              <div className="bg-white p-12 rounded-[2.5rem] text-center border border-dashed border-gray-200">
                <LayoutGrid size={48} className="mx-auto text-gray-200 mb-4" />
                <p className="text-gray-400 font-bold">Du hast noch keine Inserate veröffentlicht.</p>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {myAds.map(ad => (
                  <div 
                    key={ad.id} 
                    onClick={() => { setSelectedAd(ad); setView('detail'); }}
                    className="bg-white p-5 rounded-3xl border border-gray-100 flex gap-4 items-center hover:shadow-md transition-all cursor-pointer group"
                  >
                    <div className="w-20 h-20 bg-gray-50 rounded-2xl flex-shrink-0 flex items-center justify-center overflow-hidden">
                      {ad.image ? <img src={ad.image} className="w-full h-full object-cover" /> : <ImageIcon className="text-gray-200" />}
                    </div>
                    <div className="flex-1">
                      <h4 className="font-bold text-[#222f3e] group-hover:text-[#576574] transition-colors">{ad.title}</h4>
                      <p className="text-xs text-gray-400 font-bold">CHF {ad.price}.-</p>
                    </div>
                    <ChevronLeft className="rotate-180 text-gray-200" size={20} />
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {view === 'detail' && selectedAd && (
          <div className="bg-white sm:rounded-[2.5rem] shadow-2xl overflow-hidden max-w-5xl mx-auto flex flex-col md:flex-row border border-gray-100 min-h-[600px]">
            <div className="md:w-1/2 bg-[#f1f2f6] relative h-[400px] md:h-auto">
              {selectedAd.image ? (
                <img src={selectedAd.image} className="w-full h-full object-cover" alt={selectedAd.title} />
              ) : (
                <div className="w-full h-full flex items-center justify-center text-gray-300 flex-col gap-3">
                  <ImageIcon size={64} />
                  <span className="text-xs font-black uppercase tracking-[0.2em]">Kein Foto</span>
                </div>
              )}
              <button onClick={() => { setView(selectedAd.sellerId === user?.uid ? 'my-ads' : 'home'); setShowFullNumber(false); }} className="absolute top-6 left-6 bg-white/95 p-3 rounded-2xl shadow-xl hover:bg-white transition-all transform active:scale-95">
                <ChevronLeft size={24} />
              </button>
            </div>

            <div className="md:w-1/2 p-8 md:p-12 flex flex-col">
              <div className="mb-8">
                <div className="flex justify-between items-start mb-2">
                  <span className="text-[10px] font-black text-[#576574] uppercase tracking-widest bg-gray-100 px-3 py-1.5 rounded-lg inline-block">
                    {selectedAd.category}
                  </span>
                  <div className="text-3xl font-black text-[#222f3e]">CHF {selectedAd.price}.-</div>
                </div>
                <h2 className="text-4xl font-black text-[#222f3e] leading-tight mb-4">{selectedAd.title}</h2>
                <div className="flex items-center gap-4 text-gray-400 text-sm font-bold">
                  <div className="flex items-center gap-1.5"><MapPin size={16} /> {selectedAd.kanton}</div>
                  <div className="w-1.5 h-1.5 bg-gray-200 rounded-full"></div>
                  <div className="flex items-center gap-1.5"><User size={16} /> {selectedAd.sellerName}</div>
                </div>
              </div>

              <div className="flex-1">
                <h4 className="font-black text-xs text-gray-300 uppercase tracking-[0.2em] mb-3">Beschreibung</h4>
                <p className="text-gray-600 leading-relaxed text-lg mb-10">
                  {selectedAd.description || 'Keine Beschreibung vorhanden.'}
                </p>
              </div>

              <div className="grid grid-cols-1 gap-3">
                {selectedAd.sellerId === user?.uid ? (
                  <div className="flex flex-col gap-3">
                    <button onClick={() => { setPreviewImage(selectedAd.image); setView('edit'); }} className="w-full bg-[#576574] text-white py-5 rounded-2xl flex items-center justify-center gap-3 font-black transition-all shadow-lg hover:bg-[#222f3e] active:scale-[0.98]">
                      <Edit size={22} /> Inserat bearbeiten
                    </button>
                    <button onClick={() => setShowDeleteConfirm(true)} className="w-full bg-red-50 text-red-500 py-5 rounded-2xl flex items-center justify-center gap-3 font-black transition-all hover:bg-red-100 active:scale-[0.98]">
                      <Trash2 size={22} /> Inserat löschen
                    </button>
                  </div>
                ) : (
                  <>
                    {selectedAd.sellerPhone && (
                      <button 
                        onClick={() => showFullNumber ? window.location.href = `tel:${selectedAd.sellerPhone}` : setShowFullNumber(true)}
                        className={`w-full py-5 rounded-2xl flex items-center justify-center gap-3 font-black transition-all shadow-lg ${showFullNumber ? 'bg-green-50 text-green-600 border-2 border-green-500' : 'bg-green-500 text-white hover:bg-green-600 active:scale-[0.98]'}`}
                      >
                        <Phone size={22} /> {showFullNumber ? selectedAd.sellerPhone : 'Anrufen / Nummer anzeigen'}
                      </button>
                    )}
                    <button onClick={() => startChat(selectedAd)} className="w-full bg-[#222f3e] text-white py-5 rounded-2xl flex items-center justify-center gap-3 font-black transition-all shadow-lg hover:bg-black active:scale-[0.98]">
                      <MessageCircle size={22} /> Jetzt Chatten
                    </button>
                  </>
                )}
              </div>
            </div>
          </div>
        )}

        {(view === 'create' || view === 'edit') && (
          <div className="max-w-2xl mx-auto bg-white p-10 rounded-[2.5rem] border border-[#eee] shadow-2xl mt-4">
            <h2 className="text-3xl font-black mb-8">{view === 'edit' ? 'Inserat bearbeiten' : 'Neues Inserat'}</h2>
            <form onSubmit={handleCreateOrUpdateAd} className="space-y-6">
              <div className="relative group aspect-[16/9] bg-[#f8f9fa] rounded-3xl border-2 border-dashed border-gray-200 flex flex-col items-center justify-center cursor-pointer overflow-hidden">
                <input type="file" accept="image/*" onChange={(e) => {
                  const file = e.target.files[0];
                  if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => setPreviewImage(reader.result);
                    reader.readAsDataURL(file);
                  }
                }} className="absolute inset-0 opacity-0 cursor-pointer z-10" />
                {previewImage ? <img src={previewImage} className="w-full h-full object-cover" /> : <><Camera size={48} className="text-gray-300 mb-2" /><span className="text-sm font-black text-gray-400">FOTO HOCHLADEN</span></>}
              </div>
              <input name="title" defaultValue={selectedAd?.title || ''} required placeholder="Titel des Inserats" className="w-full p-4 bg-[#f8f9fa] rounded-2xl outline-none font-bold" />
              <div className="grid grid-cols-2 gap-4">
                <input name="price" type="number" defaultValue={selectedAd?.price || ''} required placeholder="Preis (CHF)" className="w-full p-4 bg-[#f8f9fa] rounded-2xl outline-none font-bold" />
                <select name="category" defaultValue={selectedAd?.category || 'Ruten'} className="w-full p-4 bg-[#f8f9fa] rounded-2xl outline-none font-bold">
                  {KATEGORIEN.map(k => <option key={k} value={k}>{k}</option>)}
                </select>
              </div>
              <select name="kanton" defaultValue={selectedAd?.kanton || 'Zürich'} className="w-full p-4 bg-[#f8f9fa] rounded-2xl outline-none font-bold">
                {KANTONE.map(k => <option key={k} value={k}>{k}</option>)}
              </select>
              <textarea name="description" defaultValue={selectedAd?.description || ''} rows="4" required placeholder="Zustand, Marke, Details..." className="w-full p-4 bg-[#f8f9fa] rounded-2xl outline-none resize-none font-bold"></textarea>
              <div className="flex gap-3">
                <button type="button" onClick={() => setView(selectedAd ? 'detail' : 'home')} className="flex-1 bg-gray-100 text-gray-600 py-5 rounded-2xl font-black text-lg">Abbrechen</button>
                <button type="submit" disabled={isUploading} className="flex-[2] bg-[#222f3e] text-white py-5 rounded-2xl font-black text-lg shadow-xl">
                  {isUploading ? 'Wird gespeichert...' : 'Speichern'}
                </button>
              </div>
            </form>
          </div>
        )}

        {view === 'chat' && activeChat && (
          <div className="max-w-xl mx-auto bg-white rounded-[2.5rem] border border-[#eee] flex flex-col h-[75vh] shadow-2xl overflow-hidden mt-4">
            <div className="p-5 border-b flex items-center gap-4 bg-white z-10 shadow-sm">
              <button onClick={() => setView('my-chats')} className="p-3 hover:bg-gray-50 rounded-2xl transition-all active:scale-90"><ArrowLeft size={24} /></button>
              <div className="flex-1">
                <h3 className="font-black text-[#222f3e] truncate">{activeChat.adTitle}</h3>
                <p className="text-xs font-bold text-gray-400 uppercase tracking-widest">Chat mit {activeChat.sellerId === user.uid ? (activeChat.buyerName || 'Interessent') : activeChat.sellerName}</p>
              </div>
            </div>
            <div className="flex-1 overflow-y-auto p-6 space-y-4 bg-[#f8f9fa]">
              {messages.map((m, idx) => (
                <div key={m.id || idx} className={`flex ${m.senderId === user.uid ? 'justify-end' : 'justify-start'}`}>
                  <div className={`max-w-[85%] p-4 rounded-2xl text-sm font-medium shadow-sm ${m.senderId === user.uid ? 'bg-[#576574] text-white rounded-br-none' : 'bg-white text-gray-800 rounded-bl-none border border-gray-100'}`}>
                    {m.text}
                  </div>
                </div>
              ))}
              <div ref={scrollRef} />
            </div>
            <form onSubmit={async (e) => {
              e.preventDefault();
              const text = e.target.msg.value;
              if (!text.trim()) return;
              e.target.msg.value = '';
              await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chats', activeChat.id, 'messages'), { text, senderId: user.uid, timestamp: Date.now() });
            }} className="p-5 border-t bg-white flex gap-3">
              <input name="msg" autoComplete="off" placeholder="Nachricht schreiben..." className="flex-1 bg-[#f8f9fa] p-4 rounded-2xl outline-none font-bold" />
              <button type="submit" className="bg-[#222f3e] text-white p-4 rounded-2xl shadow-lg hover:bg-black transition-all active:scale-95"><Send size={20} /></button>
            </form>
          </div>
        )}

        {view === 'account' && (
          <div className="max-w-xl mx-auto bg-white p-10 rounded-[2.5rem] border border-[#eee] shadow-2xl mt-4">
            <h2 className="text-3xl font-black mb-8 text-[#222f3e]">Profil bearbeiten</h2>
            <form onSubmit={saveProfile} className="space-y-6">
              <div className="grid grid-cols-2 gap-4">
                <input type="text" required value={profile.firstName} onChange={e => setProfile({...profile, firstName: e.target.value})} className="w-full p-4 bg-[#f8f9fa] rounded-2xl outline-none font-bold" placeholder="Vorname" />
                <input type="text" required value={profile.lastName} onChange={e => setProfile({...profile, lastName: e.target.value})} className="w-full p-4 bg-[#f8f9fa] rounded-2xl outline-none font-bold" placeholder="Nachname" />
              </div>
              <input type="email" required value={profile.email} onChange={e => setProfile({...profile, email: e.target.value})} className="w-full p-4 bg-[#f8f9fa] rounded-2xl outline-none font-bold" placeholder="E-Mail Adresse" />
              <input type="tel" value={profile.phone} onChange={e => setProfile({...profile, phone: e.target.value})} className="w-full p-4 bg-[#f8f9fa] rounded-2xl outline-none font-bold" placeholder="Mobiltelefon (z.B. 079...)" />
              <div className="flex items-center gap-4 p-5 bg-[#f8f9fa] rounded-2xl cursor-pointer" onClick={() => setProfile({...profile, showPhone: !profile.showPhone})}>
                <div className={`w-7 h-7 rounded-lg flex items-center justify-center border-2 transition-all ${profile.showPhone ? 'bg-[#576574] border-[#576574]' : 'bg-white border-gray-300'}`}>
                  {profile.showPhone && <div className="w-2.5 h-2.5 bg-white rounded-full"></div>}
                </div>
                <span className="text-sm font-bold text-[#222f3e]">Telefonnummer öffentlich anzeigen</span>
              </div>
              <button type="submit" className="w-full bg-[#222f3e] text-white py-5 rounded-2xl font-black text-lg shadow-xl hover:scale-105 transition-all">Profil speichern</button>
            </form>
          </div>
        )}

        {showDeleteConfirm && (
          <Modal onClose={() => setShowDeleteConfirm(false)}>
            <div className="text-center">
              <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <Trash2 size={32} />
              </div>
              <h3 className="text-xl font-black text-[#222f3e] mb-2">Inserat löschen?</h3>
              <p className="text-gray-500 font-medium mb-8">Möchtest du dieses Inserat wirklich unwiderruflich entfernen?</p>
              <div className="flex gap-3">
                <button onClick={() => setShowDeleteConfirm(false)} className="flex-1 py-4 bg-gray-100 text-gray-600 rounded-2xl font-bold">Abbrechen</button>
                <button onClick={deleteAd} className="flex-1 py-4 bg-red-500 text-white rounded-2xl font-bold shadow-lg shadow-red-200">Ja, löschen</button>
              </div>
            </div>
          </Modal>
        )}
      </main>

      {/* Mobile Navigation */}
      <nav className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-lg border-t sm:hidden h-20 flex items-center justify-around px-6 z-50">
        <button onClick={() => setView('home')} className={`flex flex-col items-center gap-1.5 transition-all ${view === 'home' || view === 'detail' ? 'text-[#576574] scale-110' : 'text-gray-300'}`}>
          <Search size={26} /> <span className="text-[10px] font-black uppercase tracking-widest">Entdecken</span>
        </button>
        <button onClick={() => { setPreviewImage(null); setView('create'); }} className={`flex flex-col items-center gap-1.5 transition-all ${view === 'create' ? 'text-[#576574] scale-110' : 'text-gray-300'}`}>
          <PlusCircle size={26} /> <span className="text-[10px] font-black uppercase tracking-widest">Verkaufen</span>
        </button>
        <button onClick={() => setView('my-chats')} className={`flex flex-col items-center gap-1.5 transition-all ${view === 'my-chats' || view === 'chat' ? 'text-[#576574] scale-110' : 'text-gray-300'}`}>
          <MessageCircle size={26} /> <span className="text-[10px] font-black uppercase tracking-widest">Nachrichten</span>
        </button>
        <button onClick={() => setView('account')} className={`flex flex-col items-center gap-1.5 transition-all ${view === 'account' ? 'text-[#576574] scale-110' : 'text-gray-300'}`}>
          <User size={26} /> <span className="text-[10px] font-black uppercase tracking-widest">Profil</span>
        </button>
      </nav>
    </div>
  );
}
